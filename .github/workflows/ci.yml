name: CI - Build and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Test Services
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: default_db
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Test Gateway Service
        working-directory: ./services/gateway-service
        run: mvn clean test

      - name: Test Product Service
        working-directory: ./services/product-service
        run: mvn clean test

      - name: Test User Service
        working-directory: ./services/user-service
        run: mvn clean test

      - name: Test Inventory Service
        working-directory: ./services/inventory-service
        run: mvn clean test
        # TestContainers will use Docker on ubuntu-latest to run PostgreSQL and Kafka integration tests

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            services/*/target/surefire-reports/
          retention-days: 7

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Gateway Service
        working-directory: ./services/gateway-service
        run: docker build -t gateway-service:test .

      - name: Build Product Service
        working-directory: ./services/product-service
        run: docker build -t product-service:test .

      - name: Build User Service
        working-directory: ./services/user-service
        run: docker build -t user-service:test .

      - name: Build Inventory Service
        working-directory: ./services/inventory-service
        run: docker build -t inventory-service:test .

  integration-test:
    name: Integration Tests - Docker Compose
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start services with Docker Compose
        run: docker compose up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be healthy..."
          timeout=300
          elapsed=0
          interval=10
          last_status=""

          while [ $elapsed -lt $timeout ]; do
            gateway_health=$(docker inspect --format='{{.State.Health.Status}}' gateway-service 2>/dev/null || echo "unknown")
            product_health=$(docker inspect --format='{{.State.Health.Status}}' product-service 2>/dev/null || echo "unknown")
            user_health=$(docker inspect --format='{{.State.Health.Status}}' user-service 2>/dev/null || echo "unknown")
            inventory_health=$(docker inspect --format='{{.State.Health.Status}}' inventory-service 2>/dev/null || echo "unknown")
            
            current_status="Gateway: $gateway_health | Product: $product_health | User: $user_health | Inventory: $inventory_health"
            
            # Only print if status changed
            if [ "$current_status" != "$last_status" ]; then
              echo "$current_status"
              last_status="$current_status"
            fi
            
            if [ "$gateway_health" = "healthy" ] && [ "$product_health" = "healthy" ] && [ "$user_health" = "healthy" ] && [ "$inventory_health" = "healthy" ]; then
              echo "✅ All services are healthy!"
              exit 0
            fi
            
            sleep $interval
            elapsed=$((elapsed + interval))
          done

          echo "❌ Services did not become healthy within ${timeout}s"
          docker compose logs
          exit 1

      - name: Test API Gateway Health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health)
          if [ "$response" -eq 200 ]; then
            echo "✅ Gateway health check passed"
          else
            echo "❌ Gateway health check failed with status $response"
            exit 1
          fi

      - name: Test User Service via Gateway
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/user-service/v3/api-docs)
          if [ "$response" -eq 200 ]; then
            echo "✅ User service accessible via gateway"
          else
            echo "❌ User service not accessible, status: $response"
            exit 1
          fi

      - name: Test Product Service via Gateway
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/product-service/v3/api-docs)
          if [ "$response" -eq 200 ]; then
            echo "✅ Product service accessible via gateway"
          else
            echo "❌ Product service not accessible, status: $response"
            exit 1
          fi

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Gateway Service Logs ==="
          docker logs gateway-service --tail 100
          echo "=== Product Service Logs ==="
          docker logs product-service --tail 100
          echo "=== User Service Logs ==="
          docker logs user-service --tail 100
          echo "=== Inventory Service Logs ==="
          docker logs inventory-service --tail 100

      - name: Cleanup
        if: always()
        run: docker compose down -v
